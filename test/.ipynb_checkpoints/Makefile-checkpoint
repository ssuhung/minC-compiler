# set the command to run your minC compiler
# (you can hopefully just choose one of them depending on your language)
# OCaml
minc := ../ml/minc/_build/default/bin/main.exe
# Julia
#minc := ../jl/minc/minc.jl
# Go
#minc := ../go/minc/minc
# Rust
minc := ../rs/minc/target/debug/minc

# all the C files to be tested
srcs := $(wildcard src/f*.c)
# you can change it to test only a few files. e.g., 
# srcs := $(wildcard src/f75.c) # only f00
# srcs := $(wildcard src/f0?.c) # f00 ... f09
#srcs := $(wildcard src/f05.c) # f00 ... f09

#
# don't have to change anything below
#
test_nos := $(patsubst src/f%.c,%,$(srcs))
minc_xmls := $(patsubst %,xml/f%.xml, $(test_nos))
minc_asms := $(patsubst %,asm/f%.s,   $(test_nos))
minc_exes := $(patsubst %,minc/f%.exe,$(test_nos))
gcc_exes  := $(patsubst %,gcc/f%.exe, $(test_nos))
minc_outs := $(patsubst %,out/f%.minc,$(test_nos))
gcc_outs  := $(patsubst %,out/f%.gcc, $(test_nos))
compares  := $(patsubst %,out/f%.diff,$(test_nos))

# compare results of gcc-generated executable
# and your-compiler-generated executable
all : $(compares)

$(compares) : out/f%.diff : out/f%.minc out/f%.gcc
	@echo "# take the diff of the two"
	diff out/f$*.gcc out/f$*.minc > $@

$(minc_outs) : out/f%.minc : minc/f%.exe out/dir
	@echo "# run the executable generated by gcc"
	$< | tee $@

$(minc_exes) : minc/f%.exe : asm/f%.s main.c minc/dir
	@echo "# generate the executable that calls f with your minC compiler"
	gcc -o $@ -DTEST_NO=$(shell seq $* $*) main.c $< -O0 -g

$(minc_asms) : asm/f%.s : xml/f%.xml asm/dir $(minc)
	@echo "# compile $< to asm with your minC compiler"
	$(minc) $< $@

$(minc_xmls) : xml/f%.xml : src/f%.c xml/dir
	@echo "# convert $< to $@"
	python3 ../parser/minc_to_xml.py $< > $@

$(gcc_outs) : out/f%.gcc : gcc/f%.exe out/dir
	@echo "# run the executable generated by gcc"
	$< | tee $@

$(gcc_exes) : gcc/f%.exe : src/f%.c main.c gcc/dir
	@echo "# generate the executable that calls f with gcc"
	gcc -o $@ -DTEST_NO=$(shell seq $* $*) main.c $< -O0 -g

xml/dir asm/dir gcc/dir minc/dir out/dir :
	mkdir -p $@

clean :
	rm -rf xml asm gcc minc out

.DELETE_ON_ERROR:
